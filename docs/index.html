<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title data-i18n="app_title">JetRadar</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    :root {
      --primary-color: #00bfff;
      --primary-color-rgb: 0, 122, 255;
      --secondary-color: #FF9500;
      --background-light: #ffffff;
      --secondary-bg-light: #f7f9fc;
      --text-color-light: #1c1c1e;
      --subtle-text-light: #8A8A8E;
      --border-color-light: #dfe3e8;
      --item-bg-light: #FFFFFF;
      --item-hover-bg-light: #EFEFF4;

      --background-dark: #121212;
      --secondary-bg-dark: #1e1e1e;
      --text-color-dark: #ffffff;
      --subtle-text-dark: #8D8D93;
      --border-color-dark: #2c2c2c;
      --item-bg-dark: #1C1C1E;
      --item-hover-bg-dark: #2C2C2E;

      --tg-theme-bg-color: var(--background-light);
      --tg-theme-secondary-bg-color: var(--secondary-bg-light);
      --tg-theme-text-color: var(--text-color-light);
      --tg-theme-hint-color: var(--subtle-text-light);
      --tg-theme-link-color: var(--primary-color);
      --tg-theme-button-color: var(--primary-color);
      --tg-theme-button-text-color: #FFFFFF;
      --tg-theme-header-bg-color: var(--secondary-bg-light); /* Or primary, depending on TG style */
      --tg-theme-section-bg-color: var(--secondary-bg-light);
      --tg-theme-destructive-text-color: #FF3B30; /* iOS Red */
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      line-height: 1.5;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: none; /* Prevent pull-to-refresh issues */
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--tg-theme-text-color);
      margin-bottom: 8px;
    }

    .user-info {
      font-size: 14px;
      color: var(--tg-theme-hint-color);
      margin-bottom: 16px;
      text-align: center;
    }

    .lang-select-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .lang-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color-light); /* Fallback */
      border-color: var(--tg-theme-hint-color);
      background-color: var(--tg-theme-secondary-bg-color);
      color: var(--tg-theme-text-color);
      font-size: 14px;
    }
    html[data-theme="dark"] .lang-select {
        border-color: var(--border-color-dark);
    }


    section {
      background-color: var(--tg-theme-section-bg-color);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    html[data-theme="dark"] section {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }


    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color-light); /* Fallback */
      border-color: var(--tg-theme-hint-color);
      font-size: 16px;
      background-color: var(--tg-theme-bg-color); /* Input bg should match page bg or be slightly different */
      color: var(--tg-theme-text-color);
      box-sizing: border-box;
    }
    html[data-theme="dark"] input[type="text"],
    html[data-theme="dark"] input[type="number"],
    html[data-theme="dark"] select {
        border-color: var(--border-color-dark);
    }

    input[type="text"]::placeholder,
    input[type="number"]::placeholder {
        color: var(--tg-theme-hint-color);
        opacity: 0.7;
    }


    button {
      width: 100%;
      padding: 12px 20px;
      margin-top: 8px;
      margin-bottom: 8px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      background-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      cursor: pointer;
      transition: opacity 0.2s ease-in-out;
    }
    button:hover {
      opacity: 0.85;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    button.secondary {
      background-color: var(--tg-theme-secondary-bg-color);
      color: var(--tg-theme-link-color);
      border: 1px solid var(--tg-theme-button-color);
    }


    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #walletList li,
    #searchResults li {
      background-color: var(--item-bg-light); /* Fallback */
      background-color: var(--tg-theme-secondary-bg-color);
      padding: 12px;
      border: 1px solid var(--border-color-light); /* Fallback */
      border-color: var(--tg-theme-bg-color); /* Border same as page bg for "floating" items */
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 15px;
    }
    #walletList li:hover,
    #searchResults li:hover {
      background-color: var(--item-hover-bg-light); /* Fallback */
      background-color: rgba(var(--primary-color-rgb), 0.1);
    }

    html[data-theme="dark"] #walletList li,
    html[data-theme="dark"] #searchResults li {
        background-color: var(--item-bg-dark);
        border-color: var(--tg-theme-bg-color);
    }
    html[data-theme="dark"] #walletList li:hover,
    html[data-theme="dark"] #searchResults li:hover {
        background-color: var(--item-hover-bg-dark);
    }


    .hidden {
      display: none;
    }

    .section-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--tg-theme-text-color);
    }

    /* Wallet Details Specifics */
    #walletDetailsSection .detail-item {
      margin-bottom: 10px;
      font-size: 15px;
    }
    #walletDetailsSection .detail-item strong {
      font-weight: 500;
      color: var(--tg-theme-hint-color);
    }
    #walletDetailsSection .detail-item span {
      color: var(--tg-theme-text-color);
    }

    #editAliasGroupContainer {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color-light); /* Fallback */
      border-top-color: var(--tg-theme-hint-color);
    }
    html[data-theme="dark"] #editAliasGroupContainer {
        border-top-color: var(--border-color-dark);
    }


    /* Transaction History Card */
    .tx-event-card {
      background-color: var(--tg-theme-bg-color); /* Slightly different from section for depth */
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color-light); /* Fallback */
      border-color: var(--tg-theme-hint-color);
    }
    html[data-theme="dark"] .tx-event-card {
        background-color: var(--secondary-bg-dark); /* item bg */
        border-color: var(--border-color-dark);
    }

    .tx-event-header {
      font-size: 13px;
      color: var(--tg-theme-hint-color);
      margin-bottom: 8px;
    }
    .tx-action-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 15px;
    }
    .tx-emoji { font-size: 18px; }
    .jetton-icon { width: 20px; height: 20px; border-radius: 50%; }
    .tx-amount-ton, .tx-amount-jetton, .tx-swap-ton, .tx-swap-jetton { font-weight: 600; }
    .tx-swap-arrow { color: var(--tg-theme-hint-color); }
    .tx-desc {
      font-size: 13px;
      color: var(--tg-theme-hint-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
    }
    .tx-type-plain { font-style: italic; }
    .tx-empty {
        padding: 20px;
        text-align: center;
        color: var(--tg-theme-hint-color);
    }

    /* Filter Controls */
    .filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
      align-items: center;
    }
    .filter-controls select, .filter-controls input[type="number"] {
      flex-grow: 1;
      margin-bottom: 0; /* Reset margin from global input style */
      min-width: 100px; /* Prevent excessive shrinking */
    }
    .filter-controls label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: var(--tg-theme-text-color);
        padding: 8px 0; /* Make clickable area larger */
    }
    .filter-controls input[type="checkbox"] {
      width: auto; /* Override global input style */
      margin-bottom: 0;
      accent-color: var(--tg-theme-button-color);
    }
    .filter-controls button {
        width: auto; /* Override global button style */
        padding: 10px 16px;
        font-size: 14px;
        margin-top: 0;
        margin-bottom: 0;
    }


    #visGraphContainer {
      width: 100%;
      height: 450px; /* Increased height */
      background-color: var(--tg-theme-secondary-bg-color);
      border-radius: 10px;
      border: 1px solid var(--border-color-light); /* Fallback */
      border-color: var(--tg-theme-hint-color);
      margin-top: 10px;
    }
    html[data-theme="dark"] #visGraphContainer {
        border-color: var(--border-color-dark);
    }
    #visGraphContainer p { /* For loading/error messages */
        padding: 20px;
        text-align: center;
        color: var(--tg-theme-hint-color);
    }

    /* Utility classes */
    .text-center { text-align: center; }
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }

    /* Spinner for loading states */
    .spinner {
        border: 3px solid rgba(var(--primary-color-rgb), 0.3);
        border-top-color: var(--tg-theme-button-color);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    button .spinner {
        border-top-color: var(--tg-theme-button-text-color); /* Spinner color for buttons */
    }
    .loading-overlay { /* For sections */
        position: relative;
        min-height: 100px; /* Ensure spinner is visible */
    }
    .loading-overlay::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        width: 30px;
        height: 30px;
        margin-left: -15px;
        margin-top: -15px;
        border: 4px solid rgba(var(--primary-color-rgb), 0.3);
        border-top-color: var(--tg-theme-button-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 data-i18n="app_title">JetRadar</h1>
      <p id="userInfo" class="user-info" data-i18n="loading_user">Загрузка пользователя...</p>
      <div class="lang-select-container">
        <select id="languageSwitcher" class="lang-select" aria-label="Select language">
          <option value="ru">Русский</option>
          <option value="uk">Українська</option>
          <option value="en">English</option>
        </select>
      </div>
    </header>

    <!-- === Секция «Добавить кошелек» === -->
    <section id="addWalletSection">
      <h2 class="section-header" data-i18n="add_wallet_header">Добавить кошелек</h2>
      <input
        id="walletAddressInput"
        type="text"
        data-i18n-placeholder="placeholder_wallet_address"
        placeholder="Адрес кошелька (UQ... или EQ...)"
      />
      <input
        id="walletAliasInput"
        type="text"
        data-i18n-placeholder="placeholder_wallet_alias"
        placeholder="Метка (опционально)"
      />
      <button id="addWalletButton" data-i18n="add_wallet">Добавить</button>
    </section>

    <!-- === Секция «Поиск» === -->
    <section id="searchSection">
      <h2 class="section-header" data-i18n="search_header">Поиск кошелька</h2>
      <input
        id="searchInput"
        type="text"
        data-i18n-placeholder="placeholder_search"
        placeholder="Поиск по адресу или метке..."
      />
      <button id="searchButton" data-i18n="search">Поиск</button>
      <div id="searchResultsContainer" class="mt-2">
        <ul id="searchResultsUl">
          <!-- Результаты поиска -->
        </ul>
      </div>
    </section>

    <!-- === Секция «Watchlist» === -->
    <section id="watchlistSection">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h2 class="section-header" style="margin-bottom: 0;" data-i18n="watchlist_header">Список наблюдения</h2>
        <button id="refreshWatchlistButton" class="secondary" style="width: auto; padding: 8px 12px; font-size: 14px;" data-i18n="refresh_watchlist">Обновить</button>
      </div>
      <div id="walletListContainer">
          <ul id="walletListUl">
            <!-- Сюда попадут элементы списка -->
          </ul>
      </div>
    </section>

    <!-- === Секция «Детали кошелька» === -->
    <section id="walletDetailsSection" class="hidden">
      <!-- Встроенная кнопка «Назад» не нужна, т.к. есть Telegram.WebApp.BackButton -->
      <h2 class="section-header" data-i18n="wallet_details_header">Детали кошелька</h2>
      <div id="walletSummaryContainer">
          <p class="detail-item"><strong data-i18n="address_label">Адрес:</strong> <span id="detailsAddressSpan">-</span></p>
          <p class="detail-item"><strong data-i18n="balance">Баланс:</strong> <span id="summaryBalanceSpan">-</span></p>
          <p class="detail-item"><strong data-i18n="tx_count">Кол-во транзакций:</strong> <span id="summaryTxCountSpan">-</span></p>
          <p class="detail-item"><strong data-i18n="last_activity">Последняя активность:</strong> <span id="summaryActivitySpan">-</span></p>
          <p class="detail-item"><strong data-i18n="is_scam">Скам?:</strong> <span id="summaryIsScamSpan">-</span></p>
          <p class="detail-item"><strong data-i18n="alias">Метка:</strong> <span id="summaryAliasSpan">-</span></p>
          <p class="detail-item"><strong data-i18n="group">Группа:</strong> <span id="summaryGroupSpan">-</span></p>
      </div>

      <div id="editAliasGroupContainer">
        <h3 class="section-header" style="font-size: 18px;" data-i18n="edit_alias_group_header">Изменить метку/группу</h3>
        <input
          id="editAliasInput"
          type="text"
          data-i18n-placeholder="placeholder_wallet_alias"
          placeholder="Новая метка (опционально)"
        />
        <input
          id="editGroupInput"
          type="text"
          data-i18n-placeholder="placeholder_wallet_group"
          placeholder="Новая группа (опционально)"
        />
        <button id="saveAliasGroupButton" data-i18n="save">Сохранить изменения</button>
      </div>

      <hr class="mt-2 mb-2" style="border-color: var(--tg-theme-hint-color); opacity: 0.5;"/>

      <h3 class="section-header" data-i18n="tx_history_header">
        История транзакций (<span data-i18n="tx_latest">последние</span> <span id="txLimitSpan">10</span>)
      </h3>
      <div id="txControls" class="filter-controls">
        <select id="txSortSelect" aria-label="Sort transactions">
          <option value="desc" data-i18n="sort_desc">Сначала новые</option>
          <option value="asc" data-i18n="sort_asc">Сначала старые</option>
        </select>
        <select id="txTypeFilter" aria-label="Filter transaction type">
          <option value="all" data-i18n="filter_all_types">Все типы</option>
          <option value="TonTransfer" data-i18n="filter_ton">TON переводы</option>
          <option value="JettonTransfer" data-i18n="filter_jetton_transfers">Jetton переводы</option>
          <option value="JettonSwap" data-i18n="filter_swaps">Обмены</option>
          <option value="NftTransfer" data-i18n="filter_nft">NFT переводы</option>
          <!-- Добавить другие типы по мере необходимости -->
        </select>
      </div>
      <div id="transactionHistoryContainer">
        <ul id="transactionHistoryUl">
            <!-- История транзакций -->
        </ul>
      </div>


      <hr class="mt-2 mb-2" style="border-color: var(--tg-theme-hint-color); opacity: 0.5;"/>

      <h3 class="section-header" data-i18n="graph_header">Граф транзакций</h3>
      <div id="graphFilters" class="filter-controls">
        <label><input type="checkbox" id="filterIncomingCheckbox" checked /> <span data-i18n="filter_incoming">Входящие</span></label>
        <label><input type="checkbox" id="filterOutgoingCheckbox" checked /> <span data-i18n="filter_outgoing">Исходящие</span></label>
        <label><input type="checkbox" id="filterJettonCheckbox"/> <span data-i18n="filter_jetton_only">Только Jetton</span></label>
        <input id="minAmountInput" type="number" step="0.01" min="0" data-i18n-placeholder="min_amount_placeholder" placeholder="Мин. сумма TON"/>
        <button id="applyGraphFiltersButton" data-i18n="apply_filters">Применить</button>
      </div>
      <div id="visGraphContainer">
          <!-- Граф будет здесь -->
      </div>
    </section>
  </div>

  <script type="module" src="./main.js"></script>
</body>
</html>
